// frontend/src/components/ExploitDBTable.jsx
import React, { useState, useEffect } from 'react';
// [FIX] ایمپورت با پسوند .jsx برای رفع مشکلات آدرس‌دهی مکرر
import { supabase } from '../supabaseClient.jsx'; 
import { Loader2, DatabaseZap } from 'lucide-react';

const ExploitDBTable = () => {
  const [exploits, setExploits] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchExploits = async () => {
      setLoading(true);
      setError(null);

      // [CRITICAL FIX] 
      // 1. کوئری به روز شده برای استفاده از 'ID' بزرگ (بر اساس خطای قبلی شما)
      const { data, error: fetchError } = await supabase
        .from('exploits')
        // [FIX] انتخاب ستون ID با حرف بزرگ و سایر ستون‌های مورد نیاز
        .select('ID, title, date, type, platform, author, url') 
        // [FIX] مرتب سازی بر اساس ID (کلید اصلی) با حروف بزرگ
        .order('ID', { ascending: false }) 
        .limit(20); 

      if (fetchError) {
        // لاگ کردن خطا به صورت دقیق‌تر
        console.error('Error fetching Exploit DB data:', fetchError);
        // نمایش پیام خطا به کاربر برای اشکال‌زدایی آسان‌تر
        setError(`Database Error: ${fetchError.message} (Is the 'ID' column correct and accessible?)`);
      } else {
        setExploits(data || []);
      }
      setLoading(false);
    };

    fetchExploits();
  }, []); // Fetch only on component mount

  // تابع کمکی برای برش عنوان بر اساس اندازه صفحه
  const truncateTitle = (title) => {
      // در حالت موبایل (عرض کمتر از 640 پیکسل), محدودیت کمتری اعمال شود (30 کاراکتر)
      const limit = window.innerWidth < 640 ? 30 : 50; 
      if (!title) return 'N/A';
      if (title.length > limit) {
          return title.substring(0, limit) + '...';
      }
      return title;
  }

  return (
    <div className="overflow-x-auto rounded-lg border border-gray-800">
      <table className="min-w-full divide-y divide-gray-800">
        <thead className="bg-gray-800/50">
          <tr>
            {/* کاهش Padding روی موبایل: px-3 برای موبایل و px-6 برای صفحه بزرگتر */}
            <th scope="col" className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-cyber-red uppercase tracking-wider">Date</th>
            <th scope="col" className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-cyber-red uppercase tracking-wider">Exploit Title</th>
            <th scope="col" className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-cyber-red uppercase tracking-wider">Type</th>
            <th scope="col" className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-cyber-red uppercase tracking-wider">Platform</th>
            <th scope="col" className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-cyber-red uppercase tracking-wider">Author</th>
          </tr>
        </thead>
        <tbody className="bg-cyber-card divide-y divide-gray-800">
          {loading && (
            <tr>
              <td colSpan="5" className="px-3 sm:px-6 py-10 text-center">
                <div className="flex justify-center items-center text-cyber-red">
                  <Loader2 className="animate-spin h-6 w-6 mr-3" />
                  <span>FETCHING EXPLOIT.DB_DATA...</span>
                </div>
              </td>
            </tr>
          )}
          {!loading && error && (
            <tr>
              <td colSpan="5" className="px-3 sm:px-6 py-10 text-center">
                <div className="text-cyber-red">
                  <DatabaseZap className="w-10 h-10 mx-auto mb-2" />
                  {/* نمایش پیام خطای دقیق برای اشکال‌زدایی بهتر */}
                  <span>ERROR: {error}</span>
                </div>
              </td>
            </tr>
          )}
          {!loading && !error && exploits.length === 0 && (
            <tr>
              <td colSpan="5" className="px-3 sm:px-6 py-10 text-center">
                <div className="text-gray-500">
                  <DatabaseZap className="w-10 h-10 mx-auto mb-2" />
                  <span>NO EXPLOIT DATA FOUND_</span>
                </div>
              </td>
            </tr>
          )}
          {!loading && !error && exploits.map((exploit) => (
            // [FIX] استفاده از exploit.ID که حالا مطمئنیم کوئری آن را برمی‌گرداند.
            <tr key={exploit.ID} className="hover:bg-gray-800/50 transition-colors duration-150">
              {/* کاهش Padding روی موبایل */}
              <td className="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500">{exploit.date ? new Date(exploit.date).toLocaleDateString() : 'N/A'}</td>
              <td className="px-3 sm:px-6 py-4 whitespace-nowrap text-sm font-medium text-cyber-red">
                <a href={exploit.url} target="_blank" rel="noopener noreferrer" className="hover:underline" title={exploit.title}>
                  {truncateTitle(exploit.title)}
                </a>
              </td>
              <td className="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-cyber-text">{exploit.type || 'N/A'}</td>
              <td className="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-cyber-text">{exploit.platform || 'N/A'}</td>
              <td className="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-cyber-text">{exploit.author || 'N/A'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

export default ExploitDBTable;
